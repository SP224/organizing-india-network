<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Organizing India Blog Network</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      background: #111;
      color: #fff;
    }
    #graph {
      width: 100vw;
      height: 100vh;
    }
    #search {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      padding: 8px;
      font-size: 16px;
      border-radius: 4px;
      border: none;
      width: 250px;
    } #controls {
      position: absolute;
      top: 50px;
      left: 10px;
      z-index: 10;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 4px;
    }
    #error {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #ff6b6b;
      background: rgba(0,0,0,0.9);
      padding: 20px;
      border-radius: 8px;
      max-width: 500px;
    }
    .control-button {
      background: #577590;
      color: white;
      border: none;
      padding: 5px 10px;
      margin: 2px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }OC
    .control-button:hover {
      background: #456b7a;
    }
</style>
</head>
<body>
  <input type="text" id="search" placeholder="üîç Search articles..." />
  <div id="controls">
    <button class="control-button" onclick="resetView()">Reset View</button>
    <button class="control-button" onclick="toggleLinks()">Toggle Links</button>
    <div style="margin-top: 5px; font-size: 12px;">
      <span>Nodes: <span id="nodeCount">0</span></span> |
      <span>Links: <span id="linkCount">0</span></span>
    </div>
  </div>
  <div id="graph"></div>
  <div id="error" style="display: none;"></div>
  <script>
// Google Sheets integration
const GOOGLE_SHEETS_API_KEY = 'YOUR_API_KEY_HERE'; // Replace with your API key
const SPREADSHEET_ID = '1N-CLQAwxBCJlZdhz-O8MQS210nAWh2gMJorq_H6C9AU';
const SHEET_RANGE = 'Sheet1!A:F'; // Adjust range as needed

async function loadFromGoogleSheets() {
  try {
    const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_RANGE}?key=${GOOGLE_SHEETS_API_KEY}`);
    const data = await response.json();
    
    return convertSheetsToNetworkData(data.values);
  } catch (error) {
    console.error('Google Sheets load failed, using fallback JSON:', error);
    return null;
  }
}

function convertSheetsToNetworkData(rows) {
  const [headers, ...dataRows] = rows;
  const nodes = [];
  const links = [];
  const clusterColors = {
    'Energy': '#f94144',
    'Digital': '#577590', 
    'Governance': '#f8961e',
    'Infrastructure': '#90a955',
    'Policy': '#277da1'
  };
  
  // Convert rows to nodes
  dataRows.forEach((row, index) => {
    if (row[0] && row[1]) { // Ensure title and URL exist
      nodes.push({
        id: String(index + 1),
        label: row[0], // Title
        url: row[1], // URL
        cluster: row[2] || 'Uncategorized', // Category
        color: clusterColors[row[2]] || '#999999',
        date: row[3], // Publication date
        tags: row[4] ? row[4].split(',').map(t => t.trim()) : [] // Tags
      });
    }
  });
  
  // Create topic-based connections
  createTopicConnections(nodes, links);
  
  return { nodes, links };
}

function createTopicConnections(nodes, links) {
  // Connect nodes within same cluster
  const clusterGroups = {};
  nodes.forEach(node => {
    if (!clusterGroups[node.cluster]) {
      clusterGroups[node.cluster] = [];
    }
    clusterGroups[node.cluster].push(node);
  });
  
  // Create intra-cluster connections
  Object.values(clusterGroups).forEach(cluster => {
    for (let i = 0; i < cluster.length - 1; i++) {
      for (let j = i + 1; j < Math.min(i + 3, cluster.length); j++) {
        links.push({
          source: cluster[i].id,
          target: cluster[j].id,
          strength: 1
        });
      }
    }
  });
  
  // Create cross-topic connections based on tags
  createCrossTopicConnections(nodes, links);
}

function createCrossTopicConnections(nodes, links) {
  const topicKeywords = {
    'gameTheory': ['game theory', 'collaboration', 'cooperation', 'strategy'],
    'spectrum': ['spectrum', '5g', 'broadband', 'wireless', 'telecommunications'],
    'governance': ['governance', 'regulation', 'policy', 'institutional'],
    'infrastructure': ['infrastructure', 'network', 'connectivity', 'digital']
  };
  
  // Find semantic connections
  nodes.forEach(node1 => {
    nodes.forEach(node2 => {
      if (node1.id !== node2.id && node1.cluster !== node2.cluster) {
        const similarity = calculateSemanticSimilarity(node1, node2, topicKeywords);
        if (similarity > 0.3) { // Threshold for connection
          links.push({
            source: node1.id,
            target: node2.id,
            strength: similarity,
            type: 'cross-topic'
          });
        }
      }
    });
  });
}

function calculateSemanticSimilarity(node1, node2, topicKeywords) {
  let score = 0;
  const text1 = (node1.label + ' ' + (node1.tags || []).join(' ')).toLowerCase();
  const text2 = (node2.label + ' ' + (node2.tags || []).join(' ')).toLowerCase();
  
  Object.values(topicKeywords).forEach(keywords => {
    const matches1 = keywords.filter(kw => text1.includes(kw)).length;
    const matches2 = keywords.filter(kw => text2.includes(kw)).length;
    if (matches1 > 0 && matches2 > 0) {
      score += Math.min(matches1, matches2) * 0.2;
    }
  });
  
  return Math.min(score, 1);
}
</script>

  <script src="https://unpkg.com/force-graph@1.43.0"></script>
  <script>
    const searchBox = document.getElementById("search");
    const errorDiv = document.getElementById("error");
    const nodeCountSpan = document.getElementById("nodeCount");
    const linkCountSpan = document.getElementById("linkCount");
    
    let showLinks = true;
    let originalData = null;
    
    const Graph = ForceGraph()(document.getElementById("graph"))
      .width(window.innerWidth)
      .height(window.innerHeight)
      .nodeAutoColorBy("cluster")
      .nodeLabel(node => `<div style="background: rgba(0,0,0,0.8); padding: 5px; border-radius: 3px; color: white; max-width: 200px;">${node.label}</div>`)
      .nodeRelSize(6)
      .linkWidth(2)
      .linkColor(() => '#666')
      .onNodeClick(node => {
        if (node.url) {
          window.open(node.url, "_blank");
        }
      })
      .onNodeHover(node => {
        document.body.style.cursor = node ? 'pointer' : 'default';
      });

    // Handle window resize
    window.addEventListener('resize', () => {
      Graph.width(window.innerWidth).height(window.innerHeight);
    });

    // Control functions
    function resetView() {
      Graph.zoomToFit(400);
    }
    
    function toggleLinks() {
      showLinks = !showLinks;
      if (originalData) {
        Graph.graphData({
          nodes: originalData.nodes,
          links: showLinks ? originalData.links : []
        });
      }
    }

    // Enhanced search functionality
    searchBox.addEventListener("input", () => {
      const query = searchBox.value.toLowerCase().trim();
      
      if (query === '') {
        // Show all nodes when search is empty
        Graph.nodeVisibility(() => true);
        Graph.linkVisibility(() => showLinks);
      } else {
        // Filter nodes and connected links
        const visibleNodeIds = new Set();
        
        Graph.nodeVisibility(node => {
          const isVisible = node.label.toLowerCase().includes(query) || 
                           (node.cluster && node.cluster.toLowerCase().includes(query));
          if (isVisible) {
            visibleNodeIds.add(node.id);
          }
          return isVisible;
        });
        
        Graph.linkVisibility(link => {
          return showLinks && (visibleNodeIds.has(link.source.id || link.source) || 
                              visibleNodeIds.has(link.target.id || link.target));
        });
      }
    });

    // Load and process data
    console.log('Attempting to load from GoogleSheets / fallback load graph-data.json');

loadFromGoogleSheets().then(sheetsData => {
  if (sheetsData && sheetsData.nodes && sheetsData.nodes.length > 0) {
    console.log('Loaded from Google Sheets:', sheetsData);
    originalData = sheetsData;
    Graph.graphData(sheetsData);
    nodeCountSpan.textContent = sheetsData.nodes.length;
    linkCountSpan.textContent = sheetsData.links.length;
    setTimeout(() => Graph.zoomToFit(400), 100);
  } else {
    // Fallback to graph-data.json
    return fetch("graph-data.json")
      .then(response => {
        console.log('Response status:', response.status, response.statusText);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Successfully loaded data from graph-data.json:', data);
        originalData = data;
        Graph.graphData(data);
        nodeCountSpan.textContent = data.nodes.length;
        linkCountSpan.textContent = data.links.length;
        setTimeout(() => Graph.zoomToFit(400), 100);
      })
      .catch(error => {
        console.error('Error loading data from graph-data.json:', error);
        // Your error display code here
      });
  }
}).catch(error => {
  console.error('All data sources failed:', error);
  // Your error display code here
});
        console.log('Successfully loaded data:', data);
        
        // Validate data structure
        if (!data.nodes || !Array.isArray(data.nodes)) {
          throw new Error('Invalid or missing nodes array in JSON');
        }
        
        if (!data.links || !Array.isArray(data.links)) {
          throw new Error('Invalid or missing links array in JSON');
        }
        
        // Validate node-link consistency
        const nodeIds = new Set(data.nodes.map(n => n.id));
        const invalidLinks = data.links.filter(l => 
          !nodeIds.has(l.source) || !nodeIds.has(l.target)
        );
        
        if (invalidLinks.length > 0) {
          console.warn('Found links referencing non-existent nodes:', invalidLinks);
        }
        
        // Store original data
        originalData = data;
        
        // Update counters
        nodeCountSpan.textContent = data.nodes.length;
        linkCountSpan.textContent = data.links.length;
        
        // Load graph
        Graph.graphData(data);
        
        // Auto-fit to view
        setTimeout(() => Graph.zoomToFit(400), 100);
        
        console.log('Graph successfully initialized');
        
      }
      .catch(error => {
        console.error('Error loading graph data:', error);
        errorDiv.innerHTML = `
          <h3>‚ùå Error Loading Network Graph</h3>
          <p><strong>Issue:</strong> ${error.message}</p>
          <h4>Troubleshooting Steps:</h4>
          <ul style="text-align: left; max-width: 400px;">
            <li>Check if <code>graph-data.json</code> exists in repository root</li>
            <li>Verify JSON syntax at <a href="https://jsonlint.com" target="_blank" style="color: #69b3ff;">JSONLint.com</a></li>
            <li>Ensure GitHub Pages is properly enabled</li>
            <li>Check browser console (F12) for detailed errors</li>
          </ul>
          <p><a href="https://github.com/SP224/organizing-india-network" target="_blank" style="color: #69b3ff;">View Repository</a></p>
        `;
        errorDiv.style.display = 'block';
      });
  </script>
</body>
</html>
